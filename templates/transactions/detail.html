
{% extends "base.html" %}

{% load static %}
{% load humanize %}
{% block title %}取引詳細{% endblock %}

{% block content %}

<div class="container mt-4">
    <h1 class="mb-4">取引詳細</h1>

    <!-- 商品情報 -->
    <div class="row">
        <div class="col-md-4 mb-4">
            <div class="card hover-effect">
                <div class="card-img-top position-relative">
                    <div class="sold-overlay">
                        <object type="image/svg+xml" data="{% static 'images/sold_layer.svg' %}" class="sold-image"></object>
                    </div>
                    <img src="{{ first_image.image.url }}" class="card-img-top" alt="商品画像">
                </div>
                <div class="card-body">
                    <h2 class="card-title">{{ transaction.product.title }}</h2>
                    <h5 class="card-text">¥{{ transaction.product.price | intcomma }}</h5>
                    <a href="{% url 'products:product_detail' transaction.product.id %}" class="btn btn-primary">詳細を見る</a>
                </div>
            </div>
        </div>

        <!-- 取引情報 -->
        <div class="col-md-8">
            <h2>取引画面</h2>

            <!-- ステータスごとのメッセージ -->
            {% if transaction.status == "order_confirmed" %}
                {% if user_is_buyer %}
                    <div class="alert alert-danger">
                        注文が確定しました。出品者からの発送通知をお待ちください。
                    </div>
                {% elif user_is_seller %}
                    <div class="alert alert-danger">
                        注文が確定しました。発送完了後に、「発送完了」ボタンを押してください。
                    </div>
                {% endif %}
            {% elif transaction.status == "shipped" %}
                {% if user_is_buyer %}
                    <div class="alert alert-danger">
                        出品者から発送通知が行われました。商品が到着したら「受け取り完了」ボタンを押してください。
                    </div>
                {% elif user_is_seller %}
                    <div class="alert alert-danger">
                        発送通知が完了しました。購入者からの受け取り完了通知をお待ちください。
                    </div>
                {% endif %}
            {% elif transaction.status == "received" %}
                <div class="alert alert-danger mt-3 text-center">
                    {% if user_is_buyer %}
                        出品者は
                        {% if buyer_rating_exists %}
                            すでに評価を投稿しています。
                        {% else %}
                            評価をまだ投稿していません。両者から評価が投稿されると、取引が完了します。
                        {% endif %}
                    {% elif user_is_seller %}
                        購入者は
                        {% if seller_rating_exists %}
                            すでに評価を投稿しています。
                        {% else %}
                            評価をまだ投稿していません。両者から評価が投稿されると、取引が完了します。
                        {% endif %}
                    {% endif %}
                </div>

                {% if not user_rating_exists %}
                    <!-- ログイン中のユーザーが評価を投稿していない場合、かつフォーム送信時以外に発火する -->
                    {% if not form.is_submitted %}
                        <script type="text/javascript">
                            document.addEventListener('DOMContentLoaded', function() {
                                alert("ステータスが受け取り完了に更新されました。\n両者から評価が投稿されると、取引が完了します");
                                
                                // #ratingModalをクリックする
                                var modalButton = document.getElementById('ratingModalButton');  // ボタンにidを追加
                                if (modalButton) {
                                    modalButton.click();  // ボタンをクリックしてモーダルを開く
                                }
                            });
                        </script>
                    {% endif %}
                {% endif %}

                {% if user_is_buyer %}
                    {% if user_rating_exists %}
                        <!-- 購入者が評価をすでに投稿している場合 -->
                        <button type="button" class="btn btn-secondary" disabled>
                            あなたはすでに評価を投稿しています。
                        </button>
                    {% else %}
                        <!-- 購入者が評価を投稿していない場合 -->
                        <button type="button" id="ratingModalButton" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#ratingModal">
                            出品者を評価する
                        </button>
                    {% endif %}
                    {% elif user_is_seller %}
                        {% if user_rating_exists %}
                            <!-- 出品者が評価をすでに投稿している場合 -->
                            <button type="button" class="btn btn-secondary" disabled>
                                あなたはすでに評価を投稿しています。
                            </button>
                        {% else %}
                            <!-- 出品者が評価を投稿していない場合 -->
                            <button type="button" id="ratingModalButton" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#ratingModal">
                                購入者を評価する
                            </button>
                        {% endif %}
                {% endif %}

            {% elif transaction.status == 'completed' %}
                <div class="alert alert-danger">
                    <script>
                        document.addEventListener('DOMContentLoaded', function() {
                            // アラートを表示
                            alert("取引が完了しました。\n完了した取引は購入した商品で確認できます。\nプロフィールページに移動します。");

                            // アラート後にプロフィールページへ遷移
                            window.location.href = "{% url 'accounts:profile' %}";  // アカウントページに遷移
                        });
                    </script>
                </div>
            {% endif %}

            <!-- ステータスごとのボタン -->
            {% if user == transaction.seller and transaction.status == "order_confirmed" %}
            <form id="shipping-form" method="post" action="{% url 'transactions:update_transaction_status' transaction.id %}">
                {% csrf_token %}
                <input type="hidden" name="status" value="shipped">
                <button type="submit" class="btn btn-primary">発送完了</button>
            </form>
            {% elif user == transaction.buyer and transaction.status == "shipped" %}
            <form method="post" action="{% url 'transactions:update_transaction_status' transaction.id %}">
                {% csrf_token %}
                <input type="hidden" name="status" value="received">
                <button type="submit" class="btn btn-success" id="receiveBtn">受け取り完了</button>
            </form>
            {% endif %}

            <!-- プログレスバー -->
            <ul class="progressbar mt-4">
                <li class="{% if progress_percentage >= 0 %}active{% endif %}">注文確定</li>
                <li class="{% if progress_percentage >= 20 %}active{% endif %} {% if progress_percentage >= 40 %}complete{% endif %}">未発送</li>
                <li class="{% if progress_percentage >= 40 %}active{% endif %} {% if progress_percentage >= 60 %}complete{% endif %}">発送済み</li>
                <li class="{% if progress_percentage >= 60 %}active{% endif %} {% if progress_percentage >= 80 %}complete{% endif %}">受け取り完了</li>
                <li class="{% if progress_percentage == 100 %}active complete{% endif %}">取引完了</li>
            </ul>
        </div>
    </div>
</div>

<!-- リアルタイムチャット -->
<div class="chat-container fixed-bottom">
    <h3 class="text-center">リアルタイムチャット</h3>
    <div id="chat-box">
        {% for message in messages %}
            <div class="chat-message" data-message-id="{{ message.id }}" ondblclick="setReply('{{ message.id }}', '{{ message.content }}')">
                <strong>{{ message.sender.username }}</strong>: {{ message.content }}
                {% if message.reply_to %}
                    <div class="reply-message">↳ {{ message.reply_to.content }}</div>
                {% endif %}
                {% if message.is_read %}
                    <span class="text-muted small">✔ 既読</span>
                {% endif %}
                <div class="reaction-menu">
                    <button onclick="sendReaction('{{ message.id }}', '👍')">👍</button>
                    <button onclick="sendReaction('{{ message.id }}', '❤️')">❤️</button>
                    <button onclick="sendReaction('{{ message.id }}', '😂')">😂</button>
                </div>
            </div>
        {% endfor %}
    </div>

    {% if transaction.status != "completed" %}
    <div class="chat-input-container">
        <input type="text" id="chat-input" placeholder="メッセージを入力">
        <input type="hidden" id="reply-to" value="">
        <button id="send-button">送信</button>
    </div>
    {% else %}
    <div class="alert alert-info text-center">この取引は完了しているため、チャットは履歴のみ閲覧可能です。</div>
    {% endif %}
    
    <p id="typing-indicator" style="display:none;">入力中...</p>
</div>

<!-- 評価モーダル (フォーム) -->
<div class="modal fade" id="ratingModal" tabindex="-1" aria-labelledby="ratingModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ratingModalLabel">相互評価</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{% url 'transactions:submit_transaction_rating' transaction.id %}">
                {% csrf_token %}
                <div class="modal-body">
                    <label for="rating">評価</label>
                    <div class="form-check">
                        <input type="radio" class="form-check-input" id="good" name="rating" value="good" required>
                        <label class="form-check-label" for="good">良かった</label>
                    </div>
                    <div class="form-check">
                        <input type="radio" class="form-check-input" id="bad" name="rating" value="bad">
                        <label class="form-check-label" for="bad">残念だった</label>
                    </div>

                    <label for="comment" class="mt-3">コメント</label>
                    <textarea class="form-control" id="comment" name="comment" rows="3" placeholder="コメントを入力してください"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                    <button type="submit" class="btn btn-primary">投稿</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    const transactionId = "{{ transaction.id }}";
    const chatSocket = new WebSocket(`ws://${window.location.host}/ws/chat/${transactionId}/`);

    chatSocket.onmessage = function(event) {
        const data = JSON.parse(event.data);
        console.log("🔥 WebSocket 受信データ:", data);

        const chatBox = document.getElementById("chat-box");

        if (data.type === "chat_message") {
            let newMessage = document.createElement("div");
            newMessage.classList.add("chat-message");
            newMessage.setAttribute("data-message-id", data.message_id);
            
            newMessage.innerHTML = `<strong>${data.sender}</strong>: ${data.message}`;

            if (data.reply_to && data.reply_to !== "null") {
                let replyElement = document.createElement("div");
                replyElement.classList.add("reply-message");
                replyElement.innerText = `↳ ${data.reply_to}`;
                newMessage.appendChild(replyElement);
            }

            chatBox.appendChild(newMessage);
            chatBox.scrollTop = chatBox.scrollHeight; // 最新メッセージへスクロール
        } 

        // 既読通知を受信したら、ステータスを更新
        else if (data.type === "update_is_read") {
            let msgElement = document.querySelector(`.chat-message[data-message-id="${data.message_id}"]`);
            if (msgElement) {
                msgElement.classList.add("read");  // CSS で既読スタイル適用
                msgElement.setAttribute("data-is-read", "true");

                // 既読・未読のラベル更新
                let statusElement = msgElement.querySelector(".read-status");
                if (statusElement) {
                    statusElement.innerText = "✔ 既読";
                }
            }
        }
        
        // タイピングメッセージの処理
        else if (data.typing) {
            const typingIndicator = document.getElementById("typing-indicator");
            if (typingIndicator) {
                typingIndicator.style.display = "block";
                setTimeout(() => { typingIndicator.style.display = "none"; }, 2000);
            }
        }
    };


    document.getElementById("send-button").onclick = function() {
        const messageInput = document.getElementById("chat-input");
        const replyTo = document.getElementById("reply-to").value;
        const message = messageInput.value;
        chatSocket.send(JSON.stringify({ "message": message, "reply_to": replyTo }));
        messageInput.value = "";
        document.getElementById("reply-to").value = "";
    };



    function sendReaction(messageId, reaction) {
        chatSocket.send(JSON.stringify({ "reaction": reaction, "message_id": messageId }));
    }

    function setReply(messageId, content) {
        document.getElementById("reply-to").value = messageId;
        document.getElementById("chat-input").placeholder = `返信: ${content}`;
    }

    document.getElementById("chat-input").addEventListener("input", function() {
        chatSocket.send(JSON.stringify({ "typing": true }));
    });


    function updateChatUI(messageData) {
        console.log("📌 `updateChatUI()` が実行された:", messageData);

        const chatBox = document.getElementById("chat-box");
        if (!chatBox) {
            console.error("❌ `#chat-box` が見つかりません");
            return;
        }

        const messageDiv = document.createElement("div");
        messageDiv.classList.add("chat-message");
        messageDiv.setAttribute("data-message-id", messageData.message_id);
        messageDiv.setAttribute("data-is-read", messageData.is_read ? "true" : "false");
        
        messageDiv.innerHTML = `
            <strong>${messageData.sender}</strong>: ${messageData.message}
            <span class="read-status">${messageData.is_read ? "✔ 既読" : "未読"}</span>
        `;
        
        if (messageData.reply_to) {
            const replyDiv = document.createElement("div");
            replyDiv.classList.add("reply-message");
            replyDiv.textContent = `↳ ${messageData.reply_to}`;
            messageDiv.appendChild(replyDiv);
        }

        // 既読の場合にスタイルを適用
        if (messageData.is_read) {
            messageDiv.classList.add("read");
        }

        chatBox.appendChild(messageDiv);
        chatBox.scrollTop = chatBox.scrollHeight; // 最新メッセージへスクロール
    }

</script>

<style>
    .progressbar {
        position: relative;
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: space-between;
        list-style-type: none;
    }

    .progressbar li {
        position: relative;
        text-align: center;
        text-transform: uppercase;
        width: 20%;
        color: #999999;
        font-weight: bold;
    }

    .progressbar li:before {
        display: block;
        width: 18px;
        height: 18px;
        margin: 0 auto 10px auto;
        content: '';
        text-align: center;
        border-radius: 50%;
        background-color: #f5f5f5;
        border: 2px solid #ddd;
    }

    .progressbar li:after {
        position: absolute;
        z-index: -1;
        top: 8px;
        left: -50%;
        width: 100%;
        height: 2px;
        content: '';
        background-color: #f5f5f5;
    }

    .progressbar li:first-child:after {
        content: none;
    }

    .progressbar li.active {
        color: #007bff;
    }

    .progressbar li.active:before {
        background-color: #007bff;
        border-color: #007bff;
    }

    .progressbar li.active:after {
        background-color: #007bff;
    }









    /* カードにホバー効果を追加 */
    .card.hover-effect {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .card.hover-effect:hover {
        transform: scale(1.05); /* カードが少し広がる（1.05倍） */
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); /* 影をつけて浮き上がり感を出す */
    }

    .card-img-top {
        position: relative;
        width: 100%; /* 必要に応じて調整 */
        height: 100%; /* 必要に応じて調整 */
        overflow: hidden;
    }

    .sold-overlay {
        position: absolute;
        top: 0;
        left: 0;
        z-index: 10;
        width: 30%; /* 親要素にぴったり合わせる */
    }

    .sold-image {
        width: 100%;  /* SVGを画像のサイズに合わせてぴったり配置 */
        height: 100%; /* 同じく高さも合わせる */
    }


    /* リアルタイムチャット */
    .chat-container {
        background: white;
        padding: 10px;
        width: 100%;
        max-width: 100%;
        position: fixed;
        bottom: 0;
        left: 0;
        border-top: 2px solid #ddd;
        box-shadow: 0px -2px 5px rgba(0, 0, 0, 0.1);
    }
    #chat-box {
        max-height: 250px;
        overflow-y: auto;
        border-bottom: 1px solid #ccc;
        margin-bottom: 10px;
        padding: 5px;
    }
    .chat-message {
        padding: 5px;
        border-radius: 5px;
        margin-bottom: 5px;
        background: #f1f1f1;
        position: relative;
    }
    .reply-message {
        font-size: 12px;
        color: #666;
        margin-top: 3px;
        padding-left: 10px;
        border-left: 2px solid #ccc;
    }
    .reaction-menu {
        display: none;
        position: absolute;
        right: 5px;
        bottom: 5px;
    }
    .chat-message:hover .reaction-menu {
        display: block;
    }
    .chat-input-container {
        display: flex;
        padding: 10px;
        border-top: 1px solid #ddd;
    }
    .chat-input-container input {
        flex-grow: 1;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 5px;
    }
    .chat-input-container button {
        margin-left: 10px;
        padding: 8px 15px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
    }

    /* 既読・未読のスタイル */
    .chat-message {
        padding: 10px;
        border-bottom: 1px solid #ddd;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .chat-message .read-status {
        font-size: 12px;
        color: gray;
    }

    .chat-message.read .read-status {
        color: blue;  /* 既読メッセージは青色に */
    }


</style>

{% endblock %}
