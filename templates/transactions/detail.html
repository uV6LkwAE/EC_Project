
{% extends "base.html" %}

{% load static %}
{% load humanize %}
{% block title %}取引詳細{% endblock %}

{% block content %}

<div class="container mt-4">
    <h1 class="mb-4">取引詳細</h1>

    <!-- 商品情報 -->
    <div class="row">
        <div class="col-md-4 mb-4">
            <div class="card hover-effect">
                <div class="card-img-top position-relative">
                    <div class="sold-overlay">
                        <object type="image/svg+xml" data="{% static 'images/sold_layer.svg' %}" class="sold-image"></object>
                    </div>
                    <img src="{{ first_image.image.url }}" class="card-img-top" alt="商品画像">
                </div>
                <div class="card-body">
                    <h2 class="card-title">{{ transaction.product.title }}</h2>
                    <h5 class="card-text">¥{{ transaction.product.price | intcomma }}</h5>
                    <a href="{% url 'products:product_detail' transaction.product.id %}" class="btn btn-primary">詳細を見る</a>
                </div>
            </div>
        </div>

        <!-- 取引情報 -->
        <div class="col-md-8">
            <h2>取引画面</h2>

            <!-- ステータスごとのメッセージ -->
            {% if transaction.status == "order_confirmed" %}
                {% if user_is_buyer %}
                    <div class="alert alert-danger">
                        注文が確定しました。出品者からの発送通知をお待ちください。
                    </div>
                {% elif user_is_seller %}
                    <div class="alert alert-danger">
                        注文が確定しました。発送完了後に、「発送完了」ボタンを押してください。
                    </div>
                {% endif %}
            {% elif transaction.status == "shipped" %}
                {% if user_is_buyer %}
                    <div class="alert alert-danger">
                        出品者から発送通知が行われました。商品が到着したら「受け取り完了」ボタンを押してください。
                    </div>
                {% elif user_is_seller %}
                    <div class="alert alert-danger">
                        発送通知が完了しました。購入者からの受け取り完了通知をお待ちください。
                    </div>
                {% endif %}
            {% elif transaction.status == "received" %}
                <div class="alert alert-danger mt-3 text-center">
                    {% if user_is_buyer %}
                        出品者は
                        {% if buyer_rating_exists %}
                            すでに評価を投稿しています。
                        {% else %}
                            評価をまだ投稿していません。両者から評価が投稿されると、取引が完了します。
                        {% endif %}
                    {% elif user_is_seller %}
                        購入者は
                        {% if seller_rating_exists %}
                            すでに評価を投稿しています。
                        {% else %}
                            評価をまだ投稿していません。両者から評価が投稿されると、取引が完了します。
                        {% endif %}
                    {% endif %}
                </div>

                {% if not user_rating_exists %}
                    <!-- ログイン中のユーザーが評価を投稿していない場合、かつフォーム送信時以外に発火する -->
                    {% if not form.is_submitted %}
                        <script type="text/javascript">
                            document.addEventListener('DOMContentLoaded', function() {
                                alert("ステータスが受け取り完了に更新されました。\n両者から評価が投稿されると、取引が完了します");
                                
                                // #ratingModalをクリックする
                                var modalButton = document.getElementById('ratingModalButton');  // ボタンにidを追加
                                if (modalButton) {
                                    modalButton.click();  // ボタンをクリックしてモーダルを開く
                                }
                            });
                        </script>
                    {% endif %}
                {% endif %}

                {% if user_is_buyer %}
                    {% if user_rating_exists %}
                        <!-- 購入者が評価をすでに投稿している場合 -->
                        <button type="button" class="btn btn-secondary" disabled>
                            あなたはすでに評価を投稿しています。
                        </button>
                    {% else %}
                        <!-- 購入者が評価を投稿していない場合 -->
                        <button type="button" id="ratingModalButton" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#ratingModal">
                            出品者を評価する
                        </button>
                    {% endif %}
                    {% elif user_is_seller %}
                        {% if user_rating_exists %}
                            <!-- 出品者が評価をすでに投稿している場合 -->
                            <button type="button" class="btn btn-secondary" disabled>
                                あなたはすでに評価を投稿しています。
                            </button>
                        {% else %}
                            <!-- 出品者が評価を投稿していない場合 -->
                            <button type="button" id="ratingModalButton" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#ratingModal">
                                購入者を評価する
                            </button>
                        {% endif %}
                {% endif %}

            {% elif transaction.status == 'completed' %}
                <div class="alert alert-danger">
                    <script>
                        document.addEventListener('DOMContentLoaded', function() {
                            // アラートを表示
                            alert("取引が完了しました。\n完了した取引は購入した商品で確認できます。\nプロフィールページに移動します。");

                            // アラート後にプロフィールページへ遷移
                            window.location.href = "{% url 'accounts:profile' %}";  // アカウントページに遷移
                        });
                    </script>
                </div>
            {% endif %}

            <!-- ステータスごとのボタン -->
            {% if user == transaction.seller and transaction.status == "order_confirmed" %}
            <form id="shipping-form" method="post" action="{% url 'transactions:update_transaction_status' transaction.id %}">
                {% csrf_token %}
                <input type="hidden" name="status" value="shipped">
                <button type="submit" class="btn btn-primary">発送完了</button>
            </form>
            {% elif user == transaction.buyer and transaction.status == "shipped" %}
            <form method="post" action="{% url 'transactions:update_transaction_status' transaction.id %}">
                {% csrf_token %}
                <input type="hidden" name="status" value="received">
                <button type="submit" class="btn btn-success" id="receiveBtn">受け取り完了</button>
            </form>
            {% endif %}

            <!-- プログレスバー -->
            <ul class="progressbar mt-4">
                <li class="{% if progress_percentage >= 0 %}active{% endif %}">注文確定</li>
                <li class="{% if progress_percentage >= 20 %}active{% endif %} {% if progress_percentage >= 40 %}complete{% endif %}">未発送</li>
                <li class="{% if progress_percentage >= 40 %}active{% endif %} {% if progress_percentage >= 60 %}complete{% endif %}">発送済み</li>
                <li class="{% if progress_percentage >= 60 %}active{% endif %} {% if progress_percentage >= 80 %}complete{% endif %}">受け取り完了</li>
                <li class="{% if progress_percentage == 100 %}active complete{% endif %}">取引完了</li>
            </ul>
        </div>
    </div>
</div>

<!-- リアルタイムチャット -->
<!-- <div class="chat-container">
    <h3 class="text-center">リアルタイムチャット</h3>
    <div id="chat-box">
        {% for message in messages %}
            <div class="chat-message {% if message.sender == user %}my-message{% else %}other-message{% endif %}" data-message-id="{{ message.id }}">
                {% if message.sender != user %}
                    <img src="{% static 'images/user_icon.png' %}" class="user-icon" alt="User Icon">
                {% endif %}
                <div class="message-content">
                    <p>{{ message.content }}</p>
                    <div class="message-meta">
                        <span class="timestamp">{{ message.timestamp|date:"H:i" }}</span>
                        {% if message.sender == user %}
                            <span class="read-status">{{ message.is_read|yesno:"既読,未読" }}</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>

    <div class="chat-input-container">
        <input type="text" id="chat-input" placeholder="メッセージを入力">
        <button id="send-button">送信</button>
    </div>
</div> -->

<!-- リアルタイムチャット -->
<div class="container chat-container mt-4">
    <h3 class="text-center">リアルタイムチャット</h3>
    <div id="chat-box" class="px-3 py-2">
        {% for message in messages %}
            <div class="row {% if message.sender == user %}justify-content-end{% else %}justify-content-start{% endif %} mx-0 my-1 mb-4 flex-wrap">
                {% if message.sender != user %}
                    <div class="col-auto">
                        {% if chat_partner_image %}
                            <img src="{{ chat_partner_image }}" class="user-icon" alt="User Icon" style="width: 100px;">
                        {% else %}
                            <i class="bi bi-person-circle user-icon" style="width: 100px;"></i>
                        {% endif %}
                    </div>
                {% endif %}
                <div class="col-auto message-wrapper" data-message-id="{{ message.id }}">
                    <div class="message-content {% if message.sender == user %}my-message{% else %}other-message{% endif %}">
                        <p class="m-2">{{ message.content }}</p>
                    </div>
                    <div class="message-meta">
                        <span class="timestamp">{{ message.timestamp|date:"m-d H:i" }}</span>
                        {% if message.sender == user %}
                            <span class="read-status">{{ message.is_read|yesno:"既読,未読" }}</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endfor %}

        <!-- typing-bubble のデフォルト表示はなし -->
        <div id="typing-indicator-container"></div>

        <!-- スクロールボタン (chat-box の外側に設置) -->
        <button id="scroll-bottom-btn" class="scroll-bottom-btn">
            <i class="bi bi-arrow-down-circle-fill"></i>
        </button>
    </div>



    <div class="chat-input-container">
        <input type="text" id="chat-input" class="form-control" placeholder="メッセージを入力">
        <button id="send-button" class="btn btn-primary">
            <i class="bi bi-send-fill"></i>
        </button>
    </div>
</div>

<!-- 評価モーダル (フォーム) -->
<div class="modal fade" id="ratingModal" tabindex="-1" aria-labelledby="ratingModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ratingModalLabel">相互評価</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{% url 'transactions:submit_transaction_rating' transaction.id %}">
                {% csrf_token %}
                <div class="modal-body">
                    <label for="rating">評価</label>
                    <div class="form-check">
                        <input type="radio" class="form-check-input" id="good" name="rating" value="good" required>
                        <label class="form-check-label" for="good">良かった</label>
                    </div>
                    <div class="form-check">
                        <input type="radio" class="form-check-input" id="bad" name="rating" value="bad">
                        <label class="form-check-label" for="bad">残念だった</label>
                    </div>

                    <label for="comment" class="mt-3">コメント</label>
                    <textarea class="form-control" id="comment" name="comment" rows="3" placeholder="コメントを入力してください"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                    <button type="submit" class="btn btn-primary">投稿</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.querySelectorAll(".message-wrapper").forEach(messageElement => {
    console.log("message-wrapper要素:", messageElement.outerHTML);
    console.log("data-message-id:", messageElement.dataset.messageId);
});


const transactionId = "{{ transaction.id }}";
const chatSocket = new WebSocket(`ws://${window.location.host}/ws/chat/${transactionId}/`);
const typingIndicator = document.getElementById("typing-indicator");

// 一旦さようなら
// メッセージを追加する関数
// function addMessageToChatBox(data) {
//     const chatBox = document.getElementById("chat-box");
//     let row = document.createElement("div");
//     row.classList.add("row", "mx-0", "my-1", "flex-wrap", "chat-message");
//     row.dataset.messageId = data.message_id;

//     if (data.sender === "{{ user.username }}") {
//         row.classList.add("justify-content-end");
//     } else {
//         row.classList.add("justify-content-start");

//         let icon = document.createElement("img");
//         icon.src = "{{ chat_partner_image }}";
//         icon.classList.add("user-icon");
//         row.appendChild(icon);
//     }

//     let messageContent = document.createElement("div");
//     messageContent.classList.add("col-auto", "message-content");
//     if (data.sender === "{{ user.username }}") {
//         messageContent.classList.add("my-message");
//     } else {
//         messageContent.classList.add("other-message");
//     }

//     messageContent.innerHTML = `<p class="m-2">${data.message}</p>`;

//     let metaDiv = document.createElement("div");
//     metaDiv.classList.add("d-flex", "justify-content-end", "align-items-center", "message-meta");

//     let timestamp = document.createElement("span");
//     timestamp.classList.add("timestamp", "me-2");
//     timestamp.innerText = data.timestamp;

//     metaDiv.appendChild(timestamp);

//     if (data.sender === "{{ user.username }}") {
//         let readStatus = document.createElement("span");
//         readStatus.classList.add("read-status");
//         readStatus.innerText = data.is_read ? "既読" : "未読";
//         metaDiv.appendChild(readStatus);
//     }

//     messageContent.appendChild(metaDiv);
//     row.appendChild(messageContent);
//     chatBox.appendChild(row);
//     chatBox.scrollTop = chatBox.scrollHeight;
// }

// メッセージを追加する関数
// メッセージを追加する関数
function addMessageToChatBox(data) {
    const chatBox = document.getElementById("chat-box");
    let row = document.createElement("div");
    row.classList.add("row", "mx-0", "my-1", "mb-4", "flex-wrap");

    // 送信者が現在のユーザーかどうか
    if (data.sender === "{{ user.username }}") {
        row.classList.add("justify-content-end");
    } else {
        row.classList.add("justify-content-start");

        let iconWrapper = document.createElement("div");
        iconWrapper.classList.add("col-auto");

        if (data.sender_icon) {
            // アイコンがある場合
            let icon = document.createElement("img");
            icon.src = data.sender_icon;
            icon.classList.add("user-icon");
            icon.style.width = "100px";
            iconWrapper.appendChild(icon);
        } else {
            // アイコンがない場合 (デフォルトアイコン)
            let icon = document.createElement("i");
            icon.classList.add("bi", "bi-person-circle", "user-icon");
            icon.style.fontSize = "3em"; // `width` ではなく `font-size` で調整
            icon.style.color = "gray";
            iconWrapper.appendChild(icon);
        }

        row.appendChild(iconWrapper);
    }

    let messageWrapper = document.createElement("div");
    messageWrapper.classList.add("col-auto", "message-wrapper");

    let messageContent = document.createElement("div");
    messageContent.classList.add("message-content");
    if (data.sender === "{{ user.username }}") {
        messageContent.classList.add("my-message");
    } else {
        messageContent.classList.add("other-message");
    }

    // メッセージ内容を追加
    messageContent.innerHTML = `<p class="m-2">${data.message}</p>`;

    // メタ情報（タイムスタンプ、既読）
    let metaDiv = document.createElement("div");
    metaDiv.classList.add("message-meta");

    let timestamp = document.createElement("span");
    timestamp.classList.add("timestamp");
    let formattedTimestamp = data.timestamp.slice(5, 16); // "MM-DD HH:MM"
    timestamp.innerText = formattedTimestamp;

    metaDiv.appendChild(timestamp);

    if (data.sender === "{{ user.username }}") {
        let readStatus = document.createElement("span");
        readStatus.classList.add("read-status");
        readStatus.innerText = data.is_read ? "既読" : "未読";
        metaDiv.appendChild(readStatus);
    }

    messageWrapper.appendChild(messageContent);
    messageWrapper.appendChild(metaDiv);
    row.appendChild(messageWrapper);
    chatBox.appendChild(row);

    // **自動スクロール**
    setTimeout(() => {
        chatBox.scrollTop = chatBox.scrollHeight;
    }, 100);
}




// タイピングアニメーション
const chatInput = document.getElementById("chat-input");
const chatBox = document.getElementById("chat-box");
const typingIndicatorContainer = document.getElementById("typing-indicator-container");
let typingTimeout;

// タイピングアニメーション用の要素を作成
function createTypingBubble() {
    const typingBubble = document.createElement("div");
    typingBubble.classList.add("typing-bubble");
    typingBubble.innerHTML = `
        <span class="dot"></span>
        <span class="dot middle"></span>
        <span class="dot"></span>
    `;
    return typingBubble;
}

// WebSocket メッセージ受信時の処理
chatSocket.onmessage = function(event) {
    const data = JSON.parse(event.data);
    console.log("WebSocket 受信データ:", data);

    // 入力中の通知を処理
    if (data.type === "typing") {
        // 既存の typing-bubble を削除
        typingIndicatorContainer.innerHTML = "";

        // 新しいアニメーションを追加
        const typingBubble = createTypingBubble();
        typingIndicatorContainer.appendChild(typingBubble);
        chatBox.scrollTop = chatBox.scrollHeight;

        // 1秒後に削除（新しい `typing` メッセージが来たらリセット）
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
            typingIndicatorContainer.innerHTML = "";
        }, 1000);
    }

    // 既読更新メッセージの処理
    // if (data.type === "update_is_read") {
    //     document.querySelectorAll(".chat-message").forEach(element => {
    //         if (element.dataset.messageId == data.message_id) {
    //             let readStatusElement = element.querySelector(".read-status");
    //             if (readStatusElement) {
    //                 readStatusElement.innerText = "既読";
    //             }
    //         }
    //     });
    //     return; // `chat-box` には追加しない
    // }

    // 既読更新メッセージの処理
    if (data.type === "update_is_read") {
        // alert("update_is_readを検出しました。");
        console.log("update_is_readを検出しました。");
        document.querySelectorAll(".message-wrapper").forEach(messageElement => {
            console.log("チェック中のメッセージID:", messageElement.dataset.messageId, "受信したID:", data.message_id);
            // console.log(messageElement.dataset.messageId);
            // console.log(data.message_id);
            // undefinedであることを条件に
            if (typeof messageElement.dataset.messageId === "undefined") {
                console.log("型が一致しました。");
                let readStatusElement = messageElement.querySelector(".read-status");
                if (readStatusElement) {
                    readStatusElement.innerText = "既読";
                }
            }
        });
        return; // `chat-box` には追加しない
    }

    // 通常のメッセージを追加
    if (data.type === "chat_message") {
        addMessageToChatBox(data);
    }
};

// メッセージ送信処理
document.getElementById("send-button").onclick = function() {
    const messageInput = document.getElementById("chat-input");
    const message = messageInput.value;
    chatSocket.send(JSON.stringify({ "message": message }));
    messageInput.value = "";
};

// 入力中の通知を送信
document.getElementById("chat-input").addEventListener("keydown", function() {
    chatSocket.send(JSON.stringify({ "type": "typing", "typing": true }));
});


// ページロード時に chat-box を一番下までスクロール
const scrollBottomBtn = document.getElementById("scroll-bottom-btn");

// スクロール時にボタンの表示・非表示を切り替える
chatBox.addEventListener("scroll", function() {
    let isAtBottom = chatBox.scrollHeight - chatBox.scrollTop <= chatBox.clientHeight + 10;

    if (isAtBottom) {
        scrollBottomBtn.style.display = "none";  // 一番下に到達したら非表示
    } else {
        scrollBottomBtn.style.display = "flex";  // それ以外の場合は表示
    }
});

// ボタンをクリックしたら最下部へスムーズにスクロール
scrollBottomBtn.addEventListener("click", function() {
    chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: "smooth" });
});

// ページロード時に自動スクロール
window.onload = function() {
    chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: "smooth" });
};

</script>

<style>
    .progressbar {
        position: relative;
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: space-between;
        list-style-type: none;
    }

    .progressbar li {
        position: relative;
        text-align: center;
        text-transform: uppercase;
        width: 20%;
        color: #999999;
        font-weight: bold;
    }

    .progressbar li:before {
        display: block;
        width: 18px;
        height: 18px;
        margin: 0 auto 10px auto;
        content: '';
        text-align: center;
        border-radius: 50%;
        background-color: #f5f5f5;
        border: 2px solid #ddd;
    }

    .progressbar li:after {
        position: absolute;
        z-index: -1;
        top: 8px;
        left: -50%;
        width: 100%;
        height: 2px;
        content: '';
        background-color: #f5f5f5;
    }

    .progressbar li:first-child:after {
        content: none;
    }

    .progressbar li.active {
        color: #007bff;
    }

    .progressbar li.active:before {
        background-color: #007bff;
        border-color: #007bff;
    }

    .progressbar li.active:after {
        background-color: #007bff;
    }

    /* カードにホバー効果を追加 */
    .card.hover-effect {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .card.hover-effect:hover {
        transform: scale(1.05); /* カードが少し広がる（1.05倍） */
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); /* 影をつけて浮き上がり感を出す */
    }

    .card-img-top {
        position: relative;
        width: 100%; /* 必要に応じて調整 */
        height: 100%; /* 必要に応じて調整 */
        overflow: hidden;
    }

    .sold-overlay {
        position: absolute;
        top: 0;
        left: 0;
        z-index: 10;
        width: 30%; /* 親要素にぴったり合わせる */
    }

    .sold-image {
        width: 100%;  /* SVGを画像のサイズに合わせてぴったり配置 */
        height: 100%; /* 同じく高さも合わせる */
    }


    /* リアルタイムチャット */
    .chat-container {
        margin-top: 3vh;
        padding: 2vh;
        background: white;
        border: 1px solid #ddd;
        border-radius: 5px;
    }

    /* チャットボックス */
    #chat-box {
        position: relative;
        max-height: 50vh;
        overflow-y: auto;
        padding: 2vh;
    }

    /* メッセージのラッパー */
    .message-wrapper {
        display: flex;
        flex-direction: column;
        align-items: flex-end; /* メッセージを右寄せ */
        max-width: 50vw;
    }

    /* メッセージ本体 */
    .message-content {
        display: inline-block;
        padding: 1vh 1.5vh;
        border-radius: 1vh;
        word-wrap: break-word;
    }

    /* 自分のメッセージ */
    .my-message {
        background: #0F8CFF;
        color: white;
        text-align: left;
    }

    /* 相手のメッセージ */
    .other-message {
        background: lightgray;
        color: black;
    }

    /* アイコン */
    .user-icon {
        width: 2.5em;
        height: 2.5em;
        border-radius: 50%;
        margin-right: 1vw;
    }

    /* メッセージのメタ情報（時間・既読未読） */
    .message-meta {
        display: flex;
        justify-content: flex-end;
        gap: 0.5vw;
        font-size: 1.8vh;
        color: gray;
        margin-top: 0.3vh;
    }

    /* 入力エリア */
    .chat-input-container {
        display: flex;
        padding: 2vh;
        border-top: 1px solid #ddd;
    }

    /* 共通のアイコンスタイル */
    .user-icon {
        width: 100px !important;  /* アイコンのサイズ */
        height: 100px !important;
        border-radius: 50%;
        margin-right: 1vw;
    }

    /* Bootstrap アイコンのサイズ（<i>タグ用） */
        .user-icon.bi {
        font-size: 3em; /* `width` ではなく `font-size` で変更 */
        color: gray;
    }


    /* ここ後で治す */
    /* 入力中アニメーション */
    /* 吹き出し全体 */
    .typing-bubble {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 8px 12px;
        background-color: #E6E9ED;
        border-radius: 20px;
        position: relative;
        width: 50px;
        height: 30px;
    }

    /* ドットの共通スタイル */
    .dot {
        width: 8px;
        height: 8px;
        background-color: #7F8C8D;
        border-radius: 50%;
        margin: 0 2px;
        opacity: 0.5;
        animation: typing-animation 1.5s infinite ease-in-out;
    }

    /* 中央のドットを青色に */
    .middle {
        background-color: #3498DB;
    }

    /* ドットのアニメーション */
    @keyframes typing-animation {
        0%, 100% { opacity: 0.5; transform: scale(1); }
        50% { opacity: 1; transform: scale(1.2); }
    }

    /* 各ドットに異なるアニメーションの遅延を設定 */
    .dot:nth-child(1) { animation-delay: 0s; }
    .dot:nth-child(2) { animation-delay: 0.2s; }
    .dot:nth-child(3) { animation-delay: 0.4s; }

    .scroll-bottom-btn {
        position: fixed;
        bottom: 110px; /* チャット入力エリアにかぶらないように調整 */
        left: 50%;
        transform: translateX(-50%);
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 50%;
        width: 45px;
        height: 45px;
        font-size: 22px;
        display: none; /* 初期状態では非表示 */
        align-items: center;
        justify-content: center;
        box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.2);
        cursor: pointer;
        transition: opacity 0.3s;
    }

    .scroll-bottom-btn:hover {
        background-color: #0056b3;
    }

</style>

{% endblock %}
