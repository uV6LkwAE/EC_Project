
{% extends "base.html" %}

{% load add_class %}

{% block title %}商品を出品{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2 class="mb-4">商品を出品する</h2>
    <form method="post" enctype="multipart/form-data" id="upload-form">
        {% csrf_token %}
        {{ form.non_field_errors }}
        <div class="form-group">
            <label for="title">商品名:</label>
            {{ form.title|add_class:"form-control" }}
        </div>
        <div class="form-group">
            <label for="description">商品詳細:</label>
            {{ form.description|add_class:"form-control" }}
        </div>
        <div class="form-group">
            <label for="price">価格:</label>
            {{ form.price|add_class:"form-control" }}
        </div>
        <div class="form-group">
            <label for="category">カテゴリー:</label>
            {{ form.category|add_class:"form-control" }}
        </div>
        <div class="form-group">
            <label for="condition">状態:</label>
            {{ form.condition|add_class:"form-control" }}
        </div>
        <div class="form-group">
            <label for="images">商品画像:</label>
            <input type="file" id="file-input" name="images" multiple class="form-control-file">
        </div>

        <!-- 画像プレビューエリア -->
        <div id="image-preview" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-top: 20px;"></div>

        <!-- 隠しフィールド: 画像順序を保持 -->
        <input type="hidden" name="order_data" id="order-data">

        <button type="submit" class="btn btn-primary mt-3">出品する</button>
    </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
<script>
    const imagePreview = document.getElementById('image-preview');
    const fileInput = document.getElementById('file-input');
    const orderDataInput = document.getElementById('order-data');
    const uploadedFiles = [];

    // ファイル選択時のプレビュー表示
    fileInput.addEventListener('change', (event) => {
        imagePreview.innerHTML = ''; // プレビューをクリア
        uploadedFiles.length = 0;

        const files = event.target.files;
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            uploadedFiles.push(file);

            const reader = new FileReader();
            reader.onload = (e) => {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.style.width = '100%';
                img.style.border = '1px solid #ddd';
                img.style.borderRadius = '4px';

                const div = document.createElement('div');
                div.dataset.index = i;
                div.appendChild(img);
                imagePreview.appendChild(div);
            };
            reader.readAsDataURL(file);
        }
    });

    // SortableJSでドラッグ＆ドロップを有効化
    new Sortable(imagePreview, {
        animation: 150,
        onEnd: () => {
            const orderData = [];
            document.querySelectorAll('#image-preview > div').forEach((item, index) => {
                orderData.push({ index: item.dataset.index, order: index });
            });
            orderDataInput.value = JSON.stringify(orderData); // JSON形式で順序を保持
        },
    });
</script>
{% endblock %}
