
{% extends "base.html" %}

{% load add_class_products from products_add_class %}

{% block title %}商品編集{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2 class="mb-4">商品を編集する</h2>
    <form method="post" enctype="multipart/form-data" id="edit-form">
        {% csrf_token %}
        {{ form.non_field_errors }}
        <div class="form-group">
            <label for="title">商品名:</label>
            {{ form.title|add_class_products:"form-control" }}
        </div>
        <div class="form-group">
            <label for="description">商品詳細:</label>
            {{ form.description|add_class_products:"form-control" }}
        </div>
        <div class="form-group">
            <label for="price">価格:</label>
            {{ form.price|add_class_products:"form-control" }}
        </div>
        <div class="form-group">
            <label for="category">カテゴリー:</label>
            {{ form.category|add_class_products:"form-control" }}
        </div>
        <div class="form-group">
            <label for="condition">状態:</label>
            {{ form.condition|add_class_products:"form-control" }}
        </div>
        <div class="form-group">
            <label for="new-images">新しい商品画像を追加:</label>
            <input type="file" id="file-input" name="images" multiple class="form-control-file">
        </div>

        <!-- 既存画像のプレビュー -->
        <h5>既存の画像</h5>
        <div id="existing-image-preview" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-top: 20px;">
            {% for image in product.images.all %}
            <div data-id="{{ image.id }}">
                <img src="{{ image.image.url }}" style="width: 100%; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            {% endfor %}
        </div>

        <!-- 新規アップロード画像のプレビュー -->
        <h5>新しく追加した画像</h5>
        <div id="new-image-preview" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-top: 20px;"></div>

        <!-- 隠しフィールド: 並び順データを保持 -->
        <input type="hidden" name="order_data" id="order-data">

        <button type="submit" class="btn btn-primary mt-3">保存する</button>
    </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
<script>
    const existingImagePreview = document.getElementById('existing-image-preview');
    const newImagePreview = document.getElementById('new-image-preview');
    const fileInput = document.getElementById('file-input');
    const orderDataInput = document.getElementById('order-data');
    const uploadedFiles = [];

    // 新しい画像を選択した際のプレビュー表示
    fileInput.addEventListener('change', (event) => {
        newImagePreview.innerHTML = ''; // 新規画像のプレビューをクリア
        uploadedFiles.length = 0;

        const files = event.target.files;
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            uploadedFiles.push(file);

            const reader = new FileReader();
            reader.onload = (e) => {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.style.width = '100%';
                img.style.border = '1px solid #ddd';
                img.style.borderRadius = '4px';

                const div = document.createElement('div');
                div.dataset.index = i;
                div.appendChild(img);
                newImagePreview.appendChild(div);
            };
            reader.readAsDataURL(file);
        }
    });

    // SortableJSでドラッグ＆ドロップを有効化
    new Sortable(existingImagePreview, {
        animation: 150,
        group: 'images', // グループ化して新規画像と一緒に並び替え可能に
        onEnd: updateOrderData
    });

    new Sortable(newImagePreview, {
        animation: 150,
        group: 'images', // 既存画像と統合
        onEnd: updateOrderData
    });

    // 並び替え後の順序データを更新
    function updateOrderData() {
        const orderData = [];
        document.querySelectorAll('#existing-image-preview > div, #new-image-preview > div').forEach((item, index) => {
            if (item.dataset.id) {
                orderData.push({ id: item.dataset.id, order: index }); // 既存画像
            } else if (item.dataset.index) {
                orderData.push({ index: item.dataset.index, order: index }); // 新規画像
            }
        });
        orderDataInput.value = JSON.stringify(orderData);
    }
</script>
{% endblock %}
