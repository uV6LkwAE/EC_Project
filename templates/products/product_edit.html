
{% extends "base.html" %}
{% load add_class_products from products_add_class %}

{% block title %}商品編集{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2 class="mb-4">商品を編集する</h2>
    <form method="post" enctype="multipart/form-data" id="edit-form">
        {% csrf_token %}
        {{ form.non_field_errors }}
        <div class="form-group">
            <label for="title">商品名:</label>
            {{ form.title|add_class_products:"form-control" }}
        </div>
        <div class="form-group">
            <label for="description">商品詳細:</label>
            {{ form.description|add_class_products:"form-control" }}
        </div>
        <div class="form-group">
            <label for="price">価格:</label>
            {{ form.price|add_class_products:"form-control" }}
        </div>
        <div class="form-group">
            <label for="category">カテゴリー:</label>
            {{ form.category|add_class_products:"form-control" }}
        </div>
        <div class="form-group">
            <label for="condition">状態:</label>
            {{ form.condition|add_class_products:"form-control" }}
        </div>
        <div class="form-group">
            <label for="new-images">新しい商品画像を追加:</label>
            <input type="file" id="file-input" name="images" multiple class="form-control-file">
        </div>

        <!-- 既存画像のプレビュー -->
        <h5>既存の画像</h5>
        <div id="existing-image-preview" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px;">
            {% for image in product.images.all %}
            <div class="image-container" data-id="{{ image.id }}">
                <img src="{{ image.image.url }}" style="width: 100%; border: 1px solid #ddd; border-radius: 4px;">
                <button class="delete-btn">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
            {% endfor %}
        </div>

        <!-- 新規アップロード画像のプレビュー -->
        <h5>新しく追加した画像</h5>
        <div id="new-image-preview" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px;"></div>

        <!-- 隠しフィールド: 削除された画像のIDを保持 -->
        <input type="hidden" name="deleted_images" id="deleted-images">

        <!-- 隠しフィールド: 並び順データを保持 -->
        <input type="hidden" name="order_data" id="order-data">

        <button type="submit" class="btn btn-primary mt-3">保存する</button>
    </form>
</div>

<!-- CSS -->
<style>
    .image-container {
        position: relative;
        display: inline-block;
    }

    .image-container img {
        width: 100%;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    .delete-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        background-color: rgba(255, 255, 255, 0.9);
        color: red;
        border: none;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        cursor: pointer;
        box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.2);
        transition: background-color 0.2s;
        display: none;
    }

    .image-container:hover .delete-btn {
        display: flex;
    }

    .delete-btn:hover {
        background-color: rgba(255, 0, 0, 0.8);
        color: white;
    }
</style>

<!-- JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
<script>
    const fileInput = document.getElementById('file-input');
    const newImagePreview = document.getElementById('new-image-preview');
    const existingImagePreview = document.getElementById('existing-image-preview');
    const deletedImagesInput = document.getElementById('deleted-images');
    const orderDataInput = document.getElementById('order-data');

    // 新しい画像のプレビューと削除
    fileInput.addEventListener('change', (event) => {
        const files = event.target.files;
        newImagePreview.innerHTML = ''; // プレビューをクリア

        Array.from(files).forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const container = document.createElement('div');
                container.classList.add('image-container');

                const img = document.createElement('img');
                img.src = e.target.result;

                const deleteBtn = document.createElement('button');
                deleteBtn.classList.add('delete-btn');
                deleteBtn.innerHTML = '<i class="bi bi-trash"></i>';

                deleteBtn.addEventListener('click', function () {
                    container.remove(); // 新規画像プレビューを削除
                });

                container.appendChild(img);
                container.appendChild(deleteBtn);
                newImagePreview.appendChild(container);
            };
            reader.readAsDataURL(file);
        });
    });

    // 既存画像の削除
    existingImagePreview.addEventListener('click', (event) => {
    const deleteButton = event.target.closest('.delete-btn');
    if (deleteButton) {
        const container = deleteButton.closest('.image-container');
        const imageId = container.dataset.id;

        // サーバーに削除リクエストを送信
        fetch(`/products/image/${imageId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
            .then((response) => {
                if (response.ok) {
                    // フロントエンドで削除
                    container.remove();
                } else {
                    alert('削除に失敗しました。');
                }
            })
            .catch((error) => {
                console.error('エラーが発生しました:', error);
            });

        // ユーザーが画像を削除してからすぐに詳細画面に遷移せず、編集画面にとどまる
        // submitした際に削除リクエストを処理
        event.preventDefault();
    }
});

    // SortableJSでドラッグ＆ドロップを有効化
    new Sortable(existingImagePreview, {
        animation: 150,
        group: 'images',
        onEnd: updateOrderData
    });

    new Sortable(newImagePreview, {
        animation: 150,
        group: 'images',
        onEnd: updateOrderData
    });

    // 並び替え後の順序データを更新
    function updateOrderData() {
        const orderData = [];
        document.querySelectorAll('#existing-image-preview > div, #new-image-preview > div').forEach((item, index) => {
            if (item.dataset.id) {
                orderData.push({ id: item.dataset.id, order: index });
            } else if (item.dataset.index) {
                orderData.push({ index: item.dataset.index, order: index });
            }
        });
        console.log("Updated Order Data:", orderData); // デバッグ用
        orderDataInput.value = JSON.stringify(orderData);
    }

    // フォーム送信時に削除リクエストを処理
    document.getElementById('edit-form').addEventListener('submit', (event) => {
        // 削除対象の画像がある場合
        if (deletedImages.length > 0) {
            console.log('削除対象の画像ID:', deletedImages); // デバッグ用（必要に応じて削除）

            // 削除対象画像をサーバーに送信
            fetch(`/products/image/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ deleted_images: deletedImages })
            })
            .then((response) => {
                if (!response.ok) {
                    alert('削除リクエストに失敗しました。');
                    event.preventDefault(); // 保存処理を中断
                }
            })
            .catch((error) => {
                console.error('削除リクエストのエラー:', error);
                event.preventDefault(); // 保存処理を中断
            });
        }
    });


</script>
{% endblock %}
