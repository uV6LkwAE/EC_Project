
{% extends "base.html" %}

{% block title %}{{ product.title }}{% endblock %}

{% block content %}
<script>
    // 「続きを表示」ボタンがクリックされたときにコメントを表示する
    function showMoreComments() {
        console.log("続きを表示ボタンがクリックされました");

        // すべてのコメントを表示
        const hiddenComments = document.querySelectorAll('.comment-hidden');
        hiddenComments.forEach(comment => {
            comment.classList.remove('d-none');  // コメントを表示
            comment.classList.add('d-block');    // d-blockを適用
            // アニメーションを使って表示
            comment.style.maxHeight = comment.scrollHeight + "px"; // コメントの高さを展開
        });

        // 「続きを表示」ボタンを非表示にする
        document.getElementById('show-more-comments').style.display = 'none';
        document.getElementById('show-less-comments').style.display = 'inline-block'; // 「閉じる」ボタンを表示
    }

    // コメントを閉じる関数
    function showLessComments() {
        const allComments = document.querySelectorAll('.comment');
        allComments.forEach((comment, index) => {
            if (index > 2) {  // 最初の3つを除く
                comment.classList.add('d-none');  // コメントを非表示
                comment.classList.remove('d-block'); // d-blockを削除
                comment.style.maxHeight = "0"; // 最大高さを0に設定してアニメーション
            }
        });

        // 「続きを読む」ボタンを再度表示
        document.getElementById('show-more-comments').style.display = 'inline-block';
        document.getElementById('show-less-comments').style.display = 'none'; // 閉じるボタンを非表示
    }

    // ページ読み込み時に3つ以上のコメントを非表示にする
    window.onload = function() {
        const allComments = document.querySelectorAll('.comment');
        allComments.forEach((comment, index) => {
            if (index > 2) {
                comment.classList.add('d-none');  // 3つ目以降を非表示に
                comment.classList.remove('d-block'); // d-blockを削除
                comment.style.maxHeight = "0"; // 最大高さを0に設定してアニメーション
            } else {
                comment.style.maxHeight = comment.scrollHeight + "px"; // 最初の3つは高さを自動で調整
            }
        });
    }

    // リプライ表示をトグルする関数
    function toggleReplies(commentId) {
        const repliesDiv = document.getElementById('replies-' + commentId);
        const replyForm = document.getElementById('reply-form-' + commentId);

        // スレッド（リプライ）の表示/非表示をトグル
        if (repliesDiv.style.display === 'none') {
            repliesDiv.style.display = 'block';
        } else {
            repliesDiv.style.display = 'none';
        }

        // 返信フォームの表示/非表示をトグル
        if (replyForm.style.display === 'none') {
            replyForm.style.display = 'block';
        } else {
            replyForm.style.display = 'none';
        }
    }
</script>

<div class="container mt-5">
    <div class="row">
        <div class="col-md-7 position-relative">
            <!-- メインのスライダー -->
            <div id="productCarousel" class="carousel slide" data-bs-ride="carousel">
                {% if product.status == "sold_out" %}
                <div class="sold-out">SOLD OUT</div>
                {% endif %}
                <div class="carousel-inner">
                    {% for image in product.images.all %}
                        <div class="carousel-item {% if forloop.first %}active{% endif %}">
                            <img src="{{ image.image.url }}" alt="{{ product.title }}" class="d-block w-100 img-fluid">
                        </div>
                    {% endfor %}
                </div>
                <button class="carousel-control-prev" type="button" data-bs-target="#productCarousel" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Previous</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#productCarousel" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Next</span>
                </button>
            </div>

            <!-- サムネイル -->
            <div class="mt-3 d-flex justify-content-center">
                {% for image in product.images.all %}
                    <img src="{{ image.image.url }}" alt="Thumbnail {{ forloop.counter }}" class="img-thumbnail mx-1" style="width: 80px; cursor: pointer;" data-bs-target="#productCarousel" data-bs-slide-to="{{ forloop.counter0 }}">
                {% endfor %}
            </div>
        </div>

        <div class="col-md-5">
            <!-- 商品情報 -->
            <h2>{{ product.title }}</h2>
            <p><strong>価格:</strong> ¥{{ product.price }}</p>
            <p><strong>カテゴリー:</strong> {{ product.get_category_display }}</p>
            <p><strong>状態:</strong> {{ product.get_condition_display }}</p>
            <p><strong>出品者:</strong> {{ product.seller.username }}</p>
            <p><strong>販売状況:</strong> {{ product.get_status_display }}</p>
            <p><strong>商品説明:</strong></p>
            <p>{{ product.description }}</p>

            <h3>コメント</h3>

            <div id="comments">
                {% for comment in comments %}
                    <div class="comment mt-3 comment-hidden {% if forloop.counter <= 3 %}d-block{% else %}d-none{% endif %}" id="comment-{{ comment.id }}" style="background-color: #f1f1f1; padding: 10px; border-radius: 8px; max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out;">
                        <p><strong>{{ comment.user.username }}</strong>: {{ comment.content }}</p>
                        <p><em>{{ comment.created_at }}</em></p>

                        <!-- スレッド用展開ボタン -->
                        <button class="btn btn-link" onclick="toggleReplies({{ comment.id }})">返信を表示</button>
                        
                        <!-- リプライの表示 -->
                        <div class="replies" id="replies-{{ comment.id }}" style="display:none; margin-top: 10px;">
                            {% for reply in comment.replies.all %}
                                <div class="reply" style="background-color: white; padding: 10px; margin-top: 5px; border-left: 4px solid blue; border-bottom: 1px solid #ccc;">
                                    <p><strong>{{ reply.user.username }}</strong>: {{ reply.content }}</p>
                                    <p><em>{{ reply.created_at }}</em></p>
                                </div>
                            {% empty %}
                                <p>このコメントにはリプライはありません。</p>
                            {% endfor %}
                        </div>

                        <!-- 返信フォーム -->
                        <div class="reply-form-container" id="reply-form-{{ comment.id }}" style="display:none; margin-top: 10px;">
                            <form method="POST" action="{% url 'products:product_detail' pk=product.id %}">
                                {% csrf_token %}
                                <input type="hidden" name="reply_to" value="{{ comment.id }}">

                                <div class="input-group">
                                    <textarea class="form-control" name="content" placeholder="返信を入力してください" style="height: 40px;"></textarea>
                                    <button type="submit" class="btn btn-primary input-group-append">返信する</button>
                                </div>
                            </form>
                        </div>
                    </div>
                {% empty %}
                    <p>コメントはまだありません。</p>
                {% endfor %}
            </div>

            <!-- 「続きを読む」「閉じる」ボタン -->
            {% if comments|length > 3 %}
                <div id="show-more-comments" style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="showMoreComments()">続きを読む</button>
                </div>
                <div id="show-less-comments" style="margin-top: 20px; display: none;">
                    <button class="btn btn-secondary" onclick="showLessComments()">閉じる</button>
                </div>
            {% endif %}

            <h4>コメントを追加</h4>
            <form method="POST">
                {% csrf_token %}
                {{ form.as_p }}
                <input type="hidden" id="id_reply_to" name="reply_to" value="">
                <button type="submit" class="btn btn-primary">コメントを投稿</button>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<style>
    .carousel {
        position: relative !important;
    }

    .carousel-inner {
        position: relative !important;
        z-index: 1 !important;
    }

    .sold-out {
        position: absolute !important;
        top: 10px !important;
        left: 10px !important;
        background: rgba(255, 0, 0, 0.8) !important;
        color: white !important;
        font-weight: bold !important;
        font-size: 14px !important;
        text-transform: uppercase !important;
        padding: 5px 20px !important;
        z-index: 1000 !important;
        pointer-events: none !important;
        border-radius: 5px !important;
    }

    .comment {
        background-color: #f8f9fa;
        border: 1px solid #ddd;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 5px;
        transition: max-height 0.5s ease-in-out;
        max-height: 0;
        overflow: hidden;
    }

    .replies {
        margin-left: 20px;
        background-color: #f1f1f1;
        padding: 10px;
        border-radius: 5px;
        margin-top: 5px;
    }

    .reply {
        background-color: #f8f9fa;
        border: 1px solid #ddd;
        padding: 5px;
        margin-bottom: 5px;
    }

    .reply-form-container, .replies .reply {
        width: 100%;
        max-width: 100%;
        margin-bottom: 10px;
    }

    .reply-form-container {
        margin-top: 10px;
    }

    .comment-hidden {
        display: none;
    }

    #show-more-comments, #show-less-comments {
        margin-top: 20px;
    }
</style>

{% endblock %}
