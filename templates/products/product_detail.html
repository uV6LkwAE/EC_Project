
{% extends "base.html" %}

{% block title %}{{ product.title }}{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // ページが読み込まれた後にツールチップを初期化
    document.addEventListener('DOMContentLoaded', function () {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.forEach(function (tooltipTriggerEl) {
            new bootstrap.Tooltip(tooltipTriggerEl);
        });
    });

    // モーダルウィンドウを表示する関数
    function showAllComments() {
        const modal = new bootstrap.Modal(document.getElementById('commentModal'));
        modal.show();
    }
</script>

<div class="container mt-5">
    <div class="row">
        <!-- 商品スライダー部分（左側）-->
        <div class="col-md-7 position-relative">
            <div id="productCarousel" class="carousel slide" data-bs-ride="carousel">
                {% if product.status == "sold_out" %}
                    <div class="sold-out">SOLD</div>
                {% endif %}
                <div class="carousel-inner">
                    {% for image in product.images.all %}
                        <div class="carousel-item {% if forloop.first %}active{% endif %}">
                            <img src="{{ image.image.url }}" alt="{{ product.title }}" class="d-block w-100 img-fluid">
                        </div>
                    {% endfor %}
                </div>
                <button class="carousel-control-prev" type="button" data-bs-target="#productCarousel" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Previous</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#productCarousel" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Next</span>
                </button>
            </div>

            <div class="mt-3 d-flex justify-content-center">
                {% for image in product.images.all %}
                    <img src="{{ image.image.url }}" alt="Thumbnail {{ forloop.counter }}" class="img-thumbnail mx-1" style="width: 80px; cursor: pointer;" data-bs-target="#productCarousel" data-bs-slide-to="{{ forloop.counter0 }}">
                {% endfor %}
            </div>
        </div>

        <!-- 商品情報部分（右側）-->
        <div class="col-md-5">
            <h2>{{ product.title }}</h2>
            <p><strong>価格:</strong> ¥{{ product.price }}</p>

            <div class="d-flex gap-2 mb-3">
                <!-- お気に入りボタン -->
                {% if user.is_authenticated %}
                    {% if product.seller == user %}
                    <span class="d-inline-block" tabindex="0" data-bs-toggle="tooltip" data-bs-title="自身の商品はお気に入りは追加できません">
                        <button class="btn btn-primary" disabled>
                            <i class="bi bi-bookmarks"></i> お気に入り
                        </button>
                    </span>
                    {% else %}
                        <form method="post" action="{% url 'products:toggle_favorite' product.id %}">
                            {% csrf_token %}
                            {% if is_favorited %}
                                <button type="submit" class="btn btn-danger" data-bs-toggle="tooltip" title="お気に入り解除">
                                    <i class="bi bi-bookmarks-fill"></i> お気に入り解除
                                </button>
                            {% else %}
                                <button type="submit" class="btn btn-primary" data-bs-toggle="tooltip" title="お気に入り追加">
                                    <i class="bi bi-bookmarks"></i> お気に入り
                                </button>
                            {% endif %}
                        </form>
                    {% endif %}
                {% endif %}

                <!-- コメントボタン -->
                <span class="d-inline-block" tabindex="0" data-bs-toggle="tooltip" title="コメントを確認・投稿する">
                    <button class="btn btn-secondary d-flex align-items-center" data-bs-toggle="modal" data-bs-target="#commentModal">
                        <i class="bi bi-chat-right-text-fill me-2"></i> コメント
                    </button>
                </span>

                <!-- 編集ボタン -->
                {% if user.is_authenticated and product.seller == user %}
                    {% if product.status == "available" %}
                        <!-- 販売中の場合 -->
                        <a href="{% url 'products:product_edit' product.pk %}" class="btn btn-warning" data-bs-toggle="tooltip" title="商品を編集">編集</a>
                    {% else %}
                        <!-- 売り切れの場合は無効化 -->
                        <span class="d-inline-block" tabindex="0" data-bs-toggle="tooltip" title="売り切れ商品のため編集できません">
                            <button class="btn btn-warning" style="pointer-events: none;" disabled>編集</button>
                        </span>
                    {% endif %}
                {% endif %}


                <!-- 削除ボタン -->
                {% if user.is_authenticated and product.seller == user %}
                    {% if product.status == "available" %}
                        <!-- 販売中の場合 -->
                        <a href="{% url 'products:product_delete' product.pk %}" class="btn btn-danger" data-bs-toggle="tooltip" title="商品を削除">削除</a>
                    {% else %}
                        <!-- 売り切れの場合 -->
                        <span class="d-inline-block" tabindex="0" data-bs-toggle="tooltip" title="売り切れ商品のため削除できません">
                            <button class="btn btn-danger" style="pointer-events: none;" disabled>削除</button>
                        </span>
                    {% endif %}
                {% endif %}
            </div>

            <!-- 購入ボタン -->
            {% if user.is_authenticated %}
                {% if product.status == "available" %}
                    {% if product.seller != user %}
                        <a href="{% url 'transactions:initiate_transaction' product.id %}" class="btn btn-danger w-100 mt-3">購入する</a>
                    {% else %}
                        <span class="btn btn-danger w-100 mt-3" style="pointer-events: none; opacity: 1;">
                            販売中
                        </span>
                    {% endif %}
                {% else %}
                    {% if product.seller != user %}
                        <button class="btn btn-danger w-100 mt-3" disabled>売り切れ</button>
                    {% else %}
                        <span class="btn btn-danger w-100 mt-3" style="pointer-events: none; opacity: 1;">
                            売り切れ
                        </span>
                    {% endif %}
                {% endif %}
            {% endif %}

            <!-- 商品の説明 -->
            <h4 class="mt-3" style="opacity: 0.6;">商品の説明</h4>
            <p>{{ product.description }}</p>

            <hr>

            <!-- 商品の情報 -->
            <h4 class="mt-3" style="opacity: 0.6;">商品の情報</h4>
            <p><strong style="opacity: 0.6;">カテゴリー:</strong> {{ product.get_category_display }}</p>
            <p><strong style="opacity: 0.6;">状態:</strong> {{ product.get_condition_display }}</p>

            <hr>

        </div>

    </div>
</div>

<!-- コメントモーダル -->
<div class="modal fade" id="commentModal" tabindex="-1" aria-labelledby="commentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="commentModalLabel">すべてのコメント</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="POST">
                    {% csrf_token %}
                    <textarea class="form-control" name="comment" placeholder="コメントを投稿"></textarea>
                    <button type="submit" class="btn btn-primary mt-3">投稿する</button>
                </form>

                <div id="all-comments">
                    {% for comment in comments %}
                        <div class="comment mt-3" style="background-color: #f1f1f1; padding: 10px; border-radius: 8px;">
                            <p><strong>{{ comment.user.username }}</strong>: {{ comment.content }}</p>
                            <p><em>{{ comment.created_at }}</em></p>
                            <button class="btn btn-link" data-bs-toggle="collapse" data-bs-target="#replies-{{ comment.id }}" aria-expanded="false" aria-controls="replies-{{ comment.id }}">返信</button>
                            <div id="replies-{{ comment.id }}" class="collapse">
                                {% for reply in comment.replies.all %}
                                    <div class="reply" style="background-color: white; padding: 10px; margin-top: 5px; border-left: 4px solid blue; border-bottom: 1px solid #ccc;">
                                        <p><strong>{{ reply.user.username }}</strong>: {{ reply.content }}</p>
                                        <p><em>{{ reply.created_at }}</em></p>
                                    </div>
                                {% empty %}
                                    <p>このコメントにはリプライはありません。</p>
                                {% endfor %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .sold-out {
        position: absolute;
        top: 10px;
        left: 10px;
        background-color: red;
        color: white;
        padding: 5px 20px;
        font-weight: bold;
        font-size: 14px;
        text-transform: uppercase;
        border-radius: 5px;
    }

    .carousel-inner {
        position: relative !important;
        z-index: 1 !important;
    }

    .carousel-control-prev-icon,
    .carousel-control-next-icon {
        background-color: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
    }

    .comment {
        background-color: #f8f9fa;
        border: 1px solid #ddd;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 5px;
    }

    .reply {
        background-color: #f1f1f1;
        padding: 10px;
        margin-top: 5px;
        border-left: 4px solid blue;
        border-bottom: 1px solid #ccc;
    }
</style>

{% endblock %}
