
{% extends "base.html" %}

{% block title %}{{ product.title }}{% endblock %}

{% block content %}
<script>
    // モーダルウィンドウを表示する関数
    function showAllComments() {
        const modal = new bootstrap.Modal(document.getElementById('commentModal'));
        modal.show();
    }

    // 「続きを表示」ボタンがクリックされたときにコメントを表示する
    function showMoreComments() {
        console.log("続きを表示ボタンがクリックされました");

        // すべてのコメントを表示
        const hiddenComments = document.querySelectorAll('.comment-hidden');
        hiddenComments.forEach(comment => {
            comment.classList.remove('d-none');  // コメントを表示
            comment.classList.add('d-block');    // d-blockを適用
            // アニメーションを使って表示
            comment.style.maxHeight = comment.scrollHeight + "px";
        });

        // 「続きを表示」ボタンを非表示にする
        document.getElementById('show-more-comments').style.display = 'none';
        document.getElementById('show-less-comments').style.display = 'inline-block'; // 「閉じる」ボタンを表示
    }

    // コメントを閉じる関数
    function showLessComments() {
        const allComments = document.querySelectorAll('.comment');
        allComments.forEach((comment, index) => {
            if (index > 2) {  // 最初の3つを除く
                comment.classList.add('d-none');  // コメントを非表示
                comment.classList.remove('d-block'); // d-blockを削除
                comment.style.maxHeight = "0"; // 最大高さを0に設定してアニメーション
            }
        });

        // 「続きを読む」ボタンを再度表示
        document.getElementById('show-more-comments').style.display = 'inline-block';
        document.getElementById('show-less-comments').style.display = 'none'; // 閉じるボタンを非表示
    }

    // ページ読み込み時に3つ以上のコメントを非表示にする
    window.onload = function() {
        const allComments = document.querySelectorAll('.comment');
        allComments.forEach((comment, index) => {
            if (index > 2) {
                comment.classList.add('comment-hidden');  // 3つ目以降を非表示に
                comment.classList.remove('comment-visible'); // comment-visibleクラスを削除
            }
        });
    }

    // 「返信を表示」ボタンがクリックされたときにコメントを表示する
    function toggleReplies(commentId) {
        const repliesDiv = document.getElementById('replies-' + commentId);
        const replyForm = document.getElementById('reply-form-' + commentId);

        // スレッド（リプライ）の表示/非表示をトグル
        if (repliesDiv.style.display === 'none' || repliesDiv.style.display === '') {
            repliesDiv.style.display = 'block';
            repliesDiv.style.height = repliesDiv.scrollHeight + 'px'; // スムーズに展開
        } else {
            repliesDiv.style.display = 'none';
            repliesDiv.style.height = '0'; // 非表示にする
        }

        // 返信フォームの表示/非表示をトグル
        if (replyForm.style.display === 'none' || replyForm.style.display === '') {
            replyForm.style.display = 'block';
        } else {
            replyForm.style.display = 'none';
        }
    }

    // モーダル内の「返信を表示」ボタンがクリックされたときにリプライを表示する
    function toggleRepliesInModal(commentId) {
        const repliesDiv = document.getElementById('replies-modal-' + commentId);
        const replyForm = document.getElementById('reply-form-modal-' + commentId);

        // スレッド（リプライ）の表示/非表示をトグル
        if (repliesDiv.style.display === 'none' || repliesDiv.style.display === '') {
            repliesDiv.style.display = 'block';
            repliesDiv.style.height = repliesDiv.scrollHeight + 'px'; // スムーズに展開
        } else {
            repliesDiv.style.display = 'none';
            repliesDiv.style.height = '0'; // 非表示にする
        }

        // 返信フォームの表示/非表示をトグル
        if (replyForm.style.display === 'none' || replyForm.style.display === '') {
            replyForm.style.display = 'block';
        } else {
            replyForm.style.display = 'none';
        }
    }

</script>

<!-- 商品詳細ページ -->
<div class="container mt-5">
    <div class="row">
        <div class="col-md-7 position-relative">
            <!-- 商品のスライダー -->
            <div id="productCarousel" class="carousel slide" data-bs-ride="carousel">
                {% if product.status == "sold_out" %}
                <div class="sold-out">SOLD OUT</div>
                {% endif %}
                <div class="carousel-inner">
                    {% for image in product.images.all %}
                        <div class="carousel-item {% if forloop.first %}active{% endif %}">
                            <img src="{{ image.image.url }}" alt="{{ product.title }}" class="d-block w-100 img-fluid">
                        </div>
                    {% endfor %}
                </div>
                <button class="carousel-control-prev" type="button" data-bs-target="#productCarousel" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Previous</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#productCarousel" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Next</span>
                </button>
            </div>

            <!-- サムネイル画像 -->
            <div class="mt-3 d-flex justify-content-center">
                {% for image in product.images.all %}
                    <img src="{{ image.image.url }}" alt="Thumbnail {{ forloop.counter }}" class="img-thumbnail mx-1" style="width: 80px; cursor: pointer;" data-bs-target="#productCarousel" data-bs-slide-to="{{ forloop.counter0 }}">
                {% endfor %}
            </div>
        </div>

        <div class="col-md-5">
            <h2>{{ product.title }}</h2>
            <p><strong>価格:</strong> ¥{{ product.price }}</p>
            <p><strong>カテゴリー:</strong> {{ product.get_category_display }}</p>
            <p><strong>状態:</strong> {{ product.get_condition_display }}</p>
            <p><strong>出品者:</strong> {{ product.seller.username }}</p>
            <p><strong>販売状況:</strong> {{ product.get_status_display }}</p>
            <p><strong>商品説明:</strong></p>
            <p>{{ product.description }}</p>

            <h3>コメント</h3>

            <!-- 親コメントリスト -->
            <div id="comments">
                {% for comment in comments %}
                    <div class="comment mt-3 comment-hidden {% if forloop.counter <= 2 %}comment-visible{% else %}d-none{% endif %}" id="comment-{{ comment.id }}" style="background-color: #f1f1f1; padding: 10px; border-radius: 8px; max-height: none; overflow: visible; transition: max-height 0.5s ease-in-out;">
                        <p><strong>{{ comment.user.username }}</strong>: {{ comment.content }}</p>
                        <p><em>{{ comment.created_at }}</em></p>

                        <!-- スレッド用展開ボタン -->
                        <button class="btn btn-link" onclick="toggleReplies({{ comment.id }})">{{ comment.replies.count }}件の返信</button>

                        <!-- リプライの表示 -->
                        <div class="replies" id="replies-{{ comment.id }}" style="display:none; margin-top: 10px; height: 0; transition: height 0.5s ease-in-out;">
                            {% for reply in comment.replies.all %}
                                <div class="reply" style="background-color: white; padding: 10px; margin-top: 5px; border-left: 4px solid blue; border-bottom: 1px solid #ccc;">
                                    <p><strong>{{ reply.user.username }}</strong>: {{ reply.content }}</p>
                                    <p><em>{{ reply.created_at }}</em></p>
                                </div>
                            {% empty %}
                                <p>このコメントにはリプライはありません。</p>
                            {% endfor %}
                        </div>

                        <!-- 返信フォーム -->
                        <div class="reply-form-container" id="reply-form-{{ comment.id }}" style="display:none; margin-top: 10px;">
                            <form method="POST" action="{% url 'products:product_detail' pk=product.id %}">
                                {% csrf_token %}
                                <input type="hidden" name="reply_to" value="{{ comment.id }}">

                                <div class="input-group">
                                    <textarea class="form-control" name="content" placeholder="返信を入力してください" style="height: 40px;"></textarea>
                                    <button type="submit" class="btn btn-primary input-group-append">返信する</button>
                                </div>
                            </form>
                        </div>
                    </div>
                {% empty %}
                    <p>コメントはまだありません。</p>
                {% endfor %}
            </div>

            <!-- 「もっと見る」ボタン -->
            {% if comments|length > 2 %}
                <div id="show-more-comments" style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="showAllComments()">もっと見る</button>
                </div>
            {% endif %}

            <!-- コメント追加フォーム -->
            <h4>コメントを追加</h4>
            <form method="POST">
                {% csrf_token %}
                {{ form.as_p }}
                <input type="hidden" id="id_reply_to" name="reply_to" value="">
                <button type="submit" class="btn btn-primary">コメントを投稿</button>
            </form>
        </div>
    </div>
</div>

<!-- モーダル -->
<div class="modal fade" id="commentModal" tabindex="-1" aria-labelledby="commentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="commentModalLabel">すべてのコメント</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="all-comments">
                    {% for comment in comments %}
                        <div class="comment mt-3 d-block" id="comment-{{ comment.id }}" style="background-color: #f1f1f1; padding: 10px; border-radius: 8px;">
                            <p><strong>{{ comment.user.username }}</strong>: {{ comment.content }}</p>
                            <p><em>{{ comment.created_at }}</em></p>



                            <!-- モーダル内での「返信を表示」ボタンの変更 -->
                            <button class="btn btn-link" onclick="toggleRepliesInModal({{ comment.id }})">
                                {{ comment.replies.count }}件の返信
                            </button>

                            <!-- リプライの表示 -->
                            <div class="replies" id="replies-modal-{{ comment.id }}" style="display:none; margin-top: 10px;">
                                {% for reply in comment.replies.all %}
                                    <div class="reply" style="background-color: white; padding: 10px; margin-top: 5px; border-left: 4px solid blue; border-bottom: 1px solid #ccc;">
                                        <p><strong>{{ reply.user.username }}</strong>: {{ reply.content }}</p>
                                        <p><em>{{ reply.created_at }}</em></p>
                                    </div>
                                {% empty %}
                                    <p>このコメントにはリプライはありません。</p>
                                {% endfor %}
                            </div>

                            <!-- 返信フォーム -->
                            <div class="reply-form-container" id="reply-form-modal-{{ comment.id }}" style="display:none; margin-top: 10px;">
                                <form method="POST" action="{% url 'products:product_detail' pk=product.id %}">
                                    {% csrf_token %}
                                    <input type="hidden" name="reply_to" value="{{ comment.id }}">

                                    <div class="input-group">
                                        <textarea class="form-control" name="content" placeholder="返信を入力してください" style="height: 40px;"></textarea>
                                        <button type="submit" class="btn btn-primary input-group-append">返信する</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<style>

    .modal-content {
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);  /* 影を濃く設定 */
    }

    .carousel {
        position: relative !important;
    }

    .carousel-inner {
        position: relative !important;
        z-index: 1 !important;
    }

    .sold-out {
        position: absolute !important;
        top: 10px !important;
        left: 10px !important;
        background: rgba(255, 0, 0, 0.8) !important;
        color: white !important;
        font-weight: bold !important;
        font-size: 14px !important;
        text-transform: uppercase !important;
        padding: 5px 20px !important;
        z-index: 1000 !important;
        pointer-events: none !important;
        border-radius: 5px !important;
    }

    .comment {
        background-color: #f8f9fa;
        border: 1px solid #ddd;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 5px;
        max-height: none;
        overflow: hidden;
        transition: all 0.5s ease;
    }

    .comment-hidden {
        display: none;
    }

    .comment-visible {
        display: block;
    }

    .replies {
        margin-left: 20px;
        background-color: #f1f1f1;
        padding: 10px;
        border-radius: 5px;
        margin-top: 5px;
    }

    .reply-form-container {
        margin-top: 10px;
    }

    #show-more-comments, #show-less-comments {
        margin-top: 20px;
    }
</style>

{% endblock %}
